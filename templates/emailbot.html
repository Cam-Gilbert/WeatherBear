{% extends "base.html" %}
{% block content %}
<div class="w-full mx-auto mt-10 px-12 grid grid-cols-1 md:grid-cols-4 gap-8">

  <!-- About Box -->
  <div class="md:col-span-3 p-6 bg-white rounded-xl shadow-lg">
    <h2 class="text-3xl font-bold text-gray-800 mb-3">How the Email Bot Works</h2>
    <p class="mb-4 text-lg text-gray-600">
      Each day at your selected times, WeatherBear will send a personalized email forecast based on your location and weather expertise level. The forecast is generated using data sourced from the National Weather Service, and the summary is produced using OpenAI's API to condense the local NWS office's forecast discussion. These Area Forecast Discussions (AFDs) provide detailed insight into the meteorological reasoning NWS forecasters use when creating local forecasts. I find that they are a fantastic resource for those who want more context to their forecast, and they also serve as excellent learning tools to better understand the meteorology behind the predictions. Because AFDs are often filled with jargon that can be difficult to interpret without a meteorological background, OpenAI‚Äôs language models help summarize them at varying levels of expertise so that anyone can benefit from them.
    </p>

    <h3 class="text-2xl font-bold text-gray-800 mb-2">Example Email</h3>

    <div class="flex space-x-4 mb-4" id="expertise-tabs">
      <button data-level="beginner" class="px-4 py-2 rounded bg-gray-800 text-gray-300 hover:bg-gray-700">Beginner</button>
      <button data-level="moderate" class="px-4 py-2 rounded bg-blue-500 text-white">Moderate</button>
      <button data-level="expert" class="px-4 py-2 rounded bg-gray-800 text-gray-300 hover:bg-gray-700">Expert</button>
    </div>

    <div id="email-example-beginner" class="hidden bg-gray-100 border border-gray-300 rounded p-4 text-sm text-gray-800 font-mono whitespace-pre-line">
      Subject: üå§Ô∏è Today‚Äôs Weather

      Hi! It‚Äôs currently 85¬∞F in your area with a dewpoint of 74¬∞F, which means it feels very humid. Expect scattered showers this afternoon and evening.

      Stay dry!
      - WeatherBear üêª
    </div>

    <div id="email-example-moderate" class="bg-gray-100 border border-gray-300 rounded p-4 text-sm text-gray-800 font-mono whitespace-pre-line">Subject: üå¶Ô∏è Daily Weather Update, Curt
      
      Hello Curt, it is currently 81 degrees F with a dewpoint of 42 F, for a feels-like temperature of 80 F at Buckley Space Force Base with mostly clear skies.

      Today's Forecast:
      Tonight: Mostly clear, with a low around 59. South wind around 8 mph.

      Juneteenth: Sunny. High near 96, with temperatures falling to around 94 in the afternoon. South southeast wind 5 to 10 mph, with gusts as high as 16 mph.

      Watches/Warnings in your area:

      Heat Advisory issued June 18 at 1:51PM MDT until June 21 at 6:00PM MDT by NWS Denver CO

      Summarized forecast discussion:

      A hot and dry weather pattern is unfolding for the Denver-Boulder area through the weekend, driven by strong upper-level ridging and westerly winds bringing warm air from the Desert Southwest. Today will be mostly sunny with light winds and no precipitation. Thursday sees temperatures climbing into the mid to upper 90s, thanks to compressional warming as west-southwesterly winds strengthen over Colorado‚Äîstill dry with little chance of storms.

      By Friday and Saturday, a robust ridge of high pressure combined with strong downslope winds along the I-25 corridor will push highs near or above 100 degrees, prompting a Heat Advisory for the area. The combination of dry air and gusty winds will create critical fire weather conditions, but these winds and low humidity might also reduce heat-related health issues somewhat. A Pacific Northwest trough approaches late Saturday or Sunday, with forecast uncertainty: if it arrives quickly, cooler temperatures and scattered storms may develop on the plains; if it lingers, heat will persist longer. Looking ahead to early next week, the trough will bring cooler, more unsettled weather with daily afternoon and evening storms possible, some potentially severe.

      Stay weather aware!
      - WeatherBear üêª
    </div>

    <div id="email-example-expert" class="hidden bg-gray-100 border border-gray-300 rounded p-4 text-sm text-gray-800 font-mono whitespace-pre-line">Subject: üå¶Ô∏è Daily Weather Update, Cameron

      Hello Cameron, it is currently 91 degrees F with a dewpoint of 69 F, for a feels-like temperature of 96 F at Raleigh / Durham, Raleigh-Durham International Airport with partly cloudy skies.

      Today's Forecast:
      Tonight: Mostly clear, with a low around 75. Southwest wind around 7 mph.

      Juneteenth: A chance of showers and thunderstorms after 2pm. Sunny, with a high near 96. Heat index values as high as 103. Southwest wind 8 to 12 mph, with gusts as high as 23 mph. Chance of precipitation is 40%. New rainfall amounts between a tenth and quarter of an inch possible.

      Summarized forecast discussion:

      A strong synoptic cold front currently advancing from the Mississippi Valley will traverse central North Carolina Thursday into Thursday night, serving as the principal forcing mechanism for a well-organized severe convective outbreak. Ahead of the front, SBCAPE values are forecast to reach 2000‚Äì3000 J/kg, especially over the Coastal Plain and Piedmont regions, coupled with effective bulk shear of 25‚Äì35 kt, providing sufficient bulk shear to support organized multicell clusters or even transient supercells. This environment favors damaging wind gusts and hail, with a non-zero tornado threat embedded within the convective line. The timing places storm initiation in the NW Piedmont by early afternoon, with eastward progression through the Triangle mid-afternoon and reaching the Coastal Plain by evening. Convection will diminish overnight as the front stalls offshore. Prefrontal temperatures will remain hot and humid, with heat indices exceeding 100¬∞F in some areas.

      Post-frontal conditions Friday will be comparatively cooler and less humid with subsiding diurnal convection limited mostly to the coastal fringe. However, high pressure building over the region this weekend will induce a pronounced warm-air advection pattern beneath a strengthening Bermuda High extending westward across the Mid-Atlantic. This synoptic ridge will promote a sustained heat wave, featuring daily maximum temperatures climbing into the mid- to upper 90s and heat indices rising to or above heat advisory criteria (105‚Äì109¬∞F) by Monday and Tuesday. Overnight lows will remain elevated near record warm minimums due to persistent moist advection and boundary layer decoupling. Minimal precipitation is expected through early next week as the ridge suppresses convective initiation, aside from potential weak afternoon thunderstorms Wednesday in the western Piedmont, contingent on model consistency.

    </div>
  </div>

  <!-- Right Side Column -->
<div class="md:col-span-1 flex flex-col gap-6">
  <!-- Sign Up Box -->
  <div class="p-6 bg-white rounded-xl shadow-lg">
    <h2 class="text-3xl font-bold text-gray-800 mb-3">Sign Up</h2>
    <form method="POST" action="/submit-emailbot" id="location-form" class="space-y-4">
      <input type="text" name="name" placeholder="Name" required class="w-full border p-2 rounded" />
      <input type="email" name="email" placeholder="Email" required class="w-full border p-2 rounded" />

      <div id="manual-location" class="mb-4">
        <label class="block text-md font-medium mb-1" for="location">Your Location</label>
        <input class="w-full border rounded px-3 py-2" type="text" name="location" id="location" placeholder="City or ZIP code" required>
      </div>

      <input type="hidden" name="latitude" id="latitude">
      <input type="hidden" name="longitude" id="longitude">

      <div>
        <label class="block text-md font-medium mb-1" for="expertise">Weather Knowledge Level</label>
        <select class="w-full border rounded px-3 py-2" name="expertise" id="expertise">
          <option value="none">Beginner</option>
          <option value="moderate">Intermediate</option>
          <option value="expert">Expert</option>
        </select>
      </div>

      <div>
        <label class="block text-md font-medium mb-1" for="units">Preferred Units</label>
        <select class="w-full border rounded px-3 py-2" name="units" id="units">
          <option value="imperial">Imperial</option>
          <option value="metric">Metric</option>
        </select>
      </div>

      <div>
        <label class="block text-md font-medium mb-1" for="send_times">Preferred Email Times (select 1 to 4):</label>
        <select name="send_times" id="send_times" multiple required class="w-full border rounded px-3 py-2 h-32 overflow-y-auto">
          {% for hour in range(0, 24) %}
            {% set value = "%02d:00" % hour %}
            {% if hour == 0 %}
              {% set label = "12:00 AM" %}
            {% elif hour < 12 %}
              {% set label = hour|string + ":00 AM" %}
            {% elif hour == 12 %}
              {% set label = "12:00 PM" %}
            {% else %}
              {% set label = (hour - 12)|string + ":00 PM" %}
            {% endif %}
            <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
        <p class="text-sm text-gray-500 mt-1">Hold Ctrl (or ‚åò on Mac) to select multiple times. Max 4.</p>
      </div>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-800">Submit</button>

      {% for category, message in flash_messages %}
        {% if category == 'signup' %}
          <div id="flash-message" class="mt-2 text-green-700 bg-green-100 px-4 py-2 rounded transition-opacity duration-700">
            {{ message }}
          </div>
        {% endif %}
      {% endfor %}
    </form>

    <p class="text-sm text-gray-500 mt-2" id="geo-status">Attempting to detect your location...</p>
  </div>

  <!-- Removal Box -->
  <div class="p-6 bg-white rounded-xl shadow-lg">
    <h2 class="text-3xl font-bold text-gray-800 mb-3">Unsubscribe</h2>
    <p class="mb-4 text-lg text-gray-600">
      No longer want forecasts? Enter your email address below to unsubscribe from WeatherBear emails.
    </p>
    <form method="POST" action="/unsubscribe" class="flex flex-col md:flex-row gap-4 items-start md:items-end">
      <input type="email" name="unsubscribe_email" placeholder="Your email address"
            required class="w-full md:w-1/2 border p-2 rounded" />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-800">Remove Me</button>
      {% for category, message in flash_messages %}
        {% if category == 'unsubscribe' %}
          <div id="unsub-flash-message" class="mt-2 text-green-700 bg-green-100 px-4 py-2 rounded transition-opacity duration-700">
            {{ message }}
          </div>
        {% endif %}
      {% endfor %}
    </form>
  </div>
</div>


<script>
  const sendTimes = document.getElementById('send_times');
  sendTimes.addEventListener('change', () => {
    const selected = [...sendTimes.options].filter(option => option.selected);
    if (selected.length > 4) {
      selected[selected.length - 1].selected = false;
      alert("You can only select up to 4 times.");
    }
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const fadeOut = (id) => {
      const el = document.getElementById(id);
      if (el) {
        setTimeout(() => {
          el.classList.add("opacity-0");
          setTimeout(() => el.remove(), 700);
        }, 2000);
      }
    };
    fadeOut("flash-message");
    fadeOut("unsub-flash-message");
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const buttons = document.querySelectorAll("#expertise-tabs button");
    const examples = {
      beginner: document.getElementById("email-example-beginner"),
      moderate: document.getElementById("email-example-moderate"),
      expert: document.getElementById("email-example-expert")
    };

    buttons.forEach(button => {
      button.addEventListener("click", () => {
        const level = button.dataset.level;

        // change button colors
        buttons.forEach(btn => {
          btn.classList.remove("bg-blue-500", "text-white", "hover:bg-blue-600");
          btn.classList.add("bg-gray-800", "text-gray-300", "hover:bg-gray-700");
        });
        button.classList.remove("bg-gray-800", "text-gray-300", "hover:bg-gray-700");
        button.classList.add("bg-blue-500", "text-white", "hover:bg-blue-600");

        for (const key in examples) {
          examples[key].classList.toggle("hidden", key !== level);
        }
      });
    });
  });
</script>

<script src="{{ url_for('static', filename='js/geolocation.js') }}"></script>
{% endblock %}
